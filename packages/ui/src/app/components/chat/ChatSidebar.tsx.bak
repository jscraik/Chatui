import { useEffect, useMemo, useRef, useState } from "react";

import {
  IconArchive,
  IconChat,
  IconCloseBold,
  IconCode,
  IconDotsHorizontal,
  IconFolder,
  IconGrid3x3,
  IconImage,
  IconRadio,
  IconSearch,
  IconSettings,
  IconSidebar,
  Sparkles,
} from "../../../icons";
import { Popover } from "../../../vendor/appsSdkUi";
import { useChatUISlots } from "../../slots";
import { IconBarChart, IconBook, IconCompose, IconWriting } from "../icons/ChatGPTIcons";
import { IconPickerModal } from "../modals/IconPickerModal";
import { SettingsModal } from "../modals/SettingsModal";
import { CollapsibleSection } from "../ui/base/collapsible-section";
import { ListItem } from "../ui/base/list-item";

export interface SidebarItem {
  id: string;
  label: string;
  icon: React.ReactNode;
  color?: string;
}

export interface ChatSidebarUser {
  name: string;
  accountLabel?: string;
  planLabel?: string;
}

interface ChatSidebarProps {
  isOpen: boolean;
  onToggle?: () => void;
  onProjectSelect?: (project: SidebarItem) => void;
  projects?: SidebarItem[];
  chatHistory?: string[];
  groupChats?: SidebarItem[];
  categories?: string[];
  categoryIcons?: Record<string, React.ReactNode>;
  categoryColors?: Record<string, string>;
  categoryIconColors?: Record<string, string>;
  user?: ChatSidebarUser;
}

const projectIconMap: { [key: string]: React.ReactNode } = {
  folder: <IconFolder className="size-4" />,
  chat: <IconChat className="size-4" />,
  "bar-chart": <IconBarChart className="size-4" />,
  writing: <IconWriting className="size-4" />,
  book: <IconBook className="size-4" />,
  compose: <IconCompose className="size-4" />,
};

const getProjectIcon = (iconId: string) =>
  projectIconMap[iconId] || <IconFolder className="size-4" />;

function RailButton(props: {
  icon: React.ReactNode;
  label: string;
  active?: boolean;
  onClick?: () => void;
}) {
  const { icon, label, active, onClick } = props;

  return (
    <button
      type="button"
      data-rail-item="true"
      aria-label={label}
      title={label}
      aria-current={active ? "page" : undefined}
      onClick={onClick}
      className={`mx-2 mb-1 size-10 rounded-lg flex items-center justify-center transition-colors hover:bg-white/5 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/30 ${
        active ? "bg-white/10" : ""
      }`}
    >
      {icon}
    </button>
  );
}

function ProjectSettingsModal({
  memoryOption,
  onSelectMemoryOption,
  onClose,
  onDone,
}: {
  memoryOption: "default" | "project-only";
  onSelectMemoryOption: (value: "default" | "project-only") => void;
  onClose: () => void;
  onDone: () => void;
}) {
  const dialogRef = useRef<HTMLDivElement | null>(null);

  useEffect(() => {
    const t = window.setTimeout(() => dialogRef.current?.focus(), 0);
    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        e.preventDefault();
        onClose();
      }
    };
    window.addEventListener("keydown", onKeyDown);
    return () => {
      window.clearTimeout(t);
      window.removeEventListener("keydown", onKeyDown);
    };
  }, [onClose]);

  return (
    <div
      className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[100]"
      onClick={onClose}
      role="presentation"
    >
      <div
        ref={dialogRef}
        tabIndex={-1}
        role="dialog"
        aria-modal="true"
        aria-labelledby="project-settings-title"
        className="bg-foundation-bg-dark-2 border border-white/10 text-white rounded-2xl w-[380px] shadow-2xl outline-none"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="px-6 pt-6 pb-5">
          <h2
            id="project-settings-title"
            className="text-[16px] font-semibold text-white leading-[22px] tracking-[-0.32px]"
          >
            Project settings
          </h2>
        </div>
        <div className="px-6 pb-6">
          <div className="mb-6">
            <h3 className="text-[13px] text-white/50 mb-3 font-normal leading-[18px] tracking-[-0.3px]">
              Memory
            </h3>
            <button
              onClick={() => onSelectMemoryOption("default")}
              className={`w-full text-left p-4 rounded-xl mb-3 border-2 transition-all ${
                memoryOption === "default"
                  ? "bg-foundation-accent-green/20 border-foundation-accent-green/40"
                  : "bg-transparent border-white/10 hover:border-white/20"
              }`}
            >
              <div className="flex items-start justify-between mb-2">
                <span className="text-[14px] font-semibold text-white leading-[20px] tracking-[-0.3px]">
                  Default
                </span>
              </div>
              <p className="text-[13px] text-white/50 leading-[18px] tracking-[-0.32px] font-normal">
                Project can access memories from outside chats, and vice versa.
              </p>
            </button>
            <button
              onClick={() => onSelectMemoryOption("project-only")}
              className={`w-full text-left p-4 rounded-xl border-2 transition-all ${
                memoryOption === "project-only"
                  ? "bg-foundation-accent-green/20 border-foundation-accent-green/40"
                  : "bg-transparent border-white/10 hover:border-white/20"
              }`}
            >
              <div className="flex items-start justify-between mb-2">
                <span className="text-[14px] font-semibold text-white leading-[20px] tracking-[-0.3px]">
                  Project-only
                </span>
              </div>
              <p className="text-[13px] text-white/50 leading-[18px] tracking-[-0.32px] font-normal">
                Project can only access its own memories. Its memories are hidden from outside
                chats.
              </p>
            </button>
          </div>
        </div>
        <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-white/10">
          <button
            onClick={onClose}
            className="px-4 py-2 text-[14px] text-white/70 hover:text-white hover:bg-white/5 rounded-lg transition-colors font-normal leading-[20px] tracking-[-0.3px]"
          >
            Cancel
          </button>
          <button
            onClick={onDone}
            className="px-4 py-2 text-[14px] bg-white text-foundation-text-light-primary hover:bg-white/90 rounded-lg transition-colors font-semibold leading-[20px] tracking-[-0.3px]"
          >
            Done
          </button>
        </div>
      </div>
    </div>
  );
}

export function ChatSidebar({
  isOpen,
  onToggle,
  onProjectSelect,
  projects,
  chatHistory,
  groupChats,
  categories,
  categoryIcons,
  categoryColors,
  categoryIconColors,
  user,
}: ChatSidebarProps) {
  const resolvedProjects = useMemo(() => projects ?? [], [projects]);
  const resolvedChatHistory = chatHistory ?? [];
  const resolvedGroupChats = groupChats ?? [];
  const resolvedCategories = categories ?? [];
  const resolvedCategoryIcons = categoryIcons ?? {};
  const resolvedCategoryColors = categoryColors ?? {};
  const resolvedCategoryIconColors = categoryIconColors ?? {};
  const resolvedUser: ChatSidebarUser = {
    name: user?.name ?? "User",
    accountLabel: user?.accountLabel ?? "Personal account",
    planLabel: user?.planLabel ?? "Pro",
  };

  const { sidebarFooter } = useChatUISlots();
  const [isCollapsed, setIsCollapsed] = useState(false);
  const [_searchQuery, _setSearchQuery] = useState("");
  const [_selectedAction, _setSelectedAction] = useState("chatgpt");
  const [projectName, setProjectName] = useState("");
  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [selectedProjectForIcon, setSelectedProjectForIcon] = useState<SidebarItem | null>(null);
  const [projectsData, setProjectsData] = useState<SidebarItem[]>(resolvedProjects);
  const [newProjectIcon, setNewProjectIcon] = useState("folder");
  const [newProjectColor, setNewProjectColor] = useState("text-white/60");
  const [showMoreOptions, setShowMoreOptions] = useState(false);
  const [memoryOption, setMemoryOption] = useState<"default" | "project-only">("default");
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  const [gptsExpanded, setGptsExpanded] = useState(false);
  const [projectsExpanded, setProjectsExpanded] = useState(true);
  const [groupChatsExpanded, setGroupChatsExpanded] = useState(false);
  const [yourChatsExpanded, setYourChatsExpanded] = useState(true);
  const [hoveredProject, setHoveredProject] = useState<string | null>(null);

  const onRailKeyDown = (e: React.KeyboardEvent) => {
    if (e.key !== "ArrowDown" && e.key !== "ArrowUp") return;

    const root = e.currentTarget as HTMLElement;
    const buttons = Array.from(
      root.querySelectorAll<HTMLButtonElement>('button[data-rail-item="true"]'),
    );
    const i = buttons.indexOf(document.activeElement as HTMLButtonElement);
    if (i < 0) return;

    const delta = e.key === "ArrowDown" ? 1 : -1;
    const next = buttons[(i + delta + buttons.length) % buttons.length];
    next?.focus();
    e.preventDefault();
  };

  useEffect(() => {
    setProjectsData(resolvedProjects);
  }, [resolvedProjects]);

  const handleNewChat = () => {
    _setSelectedAction("chatgpt");
    console.log("Starting new chat");
    onToggle?.();
  };

  const toggleCategory = (category: string) => {
    setSelectedCategories((prev) => {
      const newCategories = prev.includes(category)
        ? prev.filter((c) => c !== category)
        : [...prev, category];
      setProjectName(newCategories.join(" "));
      return newCategories;
    });
  };

  const handleCreateProject = () => {
    console.log("Creating project:", {
      name: projectName,
      categories: selectedCategories,
    });
    setProjectName("");
    setSelectedCategories([]);
  };

  const handleIconChange = (iconId: string, color: string) => {
    if (selectedProjectForIcon) {
      const newIcon = getProjectIcon(iconId);
      const updatedProjects = projectsData.map((project) =>
        project.id === selectedProjectForIcon.id ? { ...project, icon: newIcon, color } : project,
      );
      setProjectsData(updatedProjects);
    }
    setShowIconPicker(false);
    setSelectedProjectForIcon(null);
  };

  const handleNewProjectIconChange = (iconId: string, color: string) => {
    setNewProjectIcon(iconId);
    setNewProjectColor(color);
    setShowIconPicker(false);
  };

  const handleProjectSelect = (project: SidebarItem) => {
    _setSelectedAction(project.id);
    if (onProjectSelect) {
      onProjectSelect(project);
    }
    onToggle?.();
  };

  const renderProjectIcon = (project: SidebarItem) => {
    if (!project.icon) return null;
    return project.color ? <span className={project.color}>{project.icon}</span> : project.icon;
  };

  const renderProjectActions = (projectId: string) =>
    hoveredProject === projectId ? (
      <button
        type="button"
        aria-label="Project options"
        className="p-1.5 hover:bg-white/10 rounded-md transition-colors"
        onClick={(e) => {
          e.stopPropagation();
          console.log("Project options");
        }}
      >
        <IconDotsHorizontal className="size-4 text-foundation-text-light-tertiary dark:text-foundation-text-dark-tertiary" />
      </button>
    ) : null;

  if (!isOpen) {
    return null;
  }

  // Collapsed icon-only rail render path
  if (isCollapsed) {
    return (
      <div
        role="navigation"
        aria-label="Sidebar"
        onKeyDown={onRailKeyDown}
        className="bg-foundation-bg-light-1 dark:bg-foundation-bg-dark-1 border-r border-foundation-bg-light-3 dark:border-white/10 transition-all duration-300 w-[60px] flex flex-col h-full"
      >
        {/* Expand toggle */}
        <div className="flex items-center justify-center px-3 py-3">
          <button
            type="button"
            onClick={() => setIsCollapsed(false)}
            aria-label="Expand sidebar"
            title="Expand sidebar"
            className="size-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition-colors"
          >
            <IconSidebar className="size-5 text-foundation-text-light-tertiary dark:text-foundation-text-dark-tertiary" />
          </button>
        </div>

        {/* Primary actions */}
        <RailButton icon={<IconCompose className="size-4" />} label="New chat" onClick={handleNewChat} />
        <RailButton icon={<IconSearch className="size-4" />} label="Search chats" />
        <RailButton icon={<IconRadio className="size-4" />} label="Pulse" />
        <RailButton icon={<IconImage className="size-4" />} label="Images" />
        <RailButton icon={<IconGrid3x3 className="size-4" />} label="Apps" />
        <RailButton icon={<IconCode className="size-4" />} label="Codex" />
        <RailButton icon={<IconArchive className="size-4" />} label="Archived chats" />

        <div className="mx-2 my-2 border-t border-white/10" />

        {/* Projects */}
        <div role="group" aria-label="Projects" className="flex-1 overflow-y-auto">
          {resolvedProjects.map((p) => (
            <RailButton
              key={p.id}
              icon={renderProjectIcon(p)}
              label={p.label}
              active={_selectedAction === p.id}
              onClick={() => handleProjectSelect(p)}
            />
          ))}

          {/* Group chats */}
          {resolvedGroupChats.map((g) => (
            <RailButton
              key={g.id}
              icon={renderProjectIcon(g)}
              label={g.label}
              active={_selectedAction === g.id}
              onClick={() => handleProjectSelect(g)}
            />
          ))}
        </div>

        {/* Account menu */}
        <div className="p-2 border-t border-white/10">
          <button
            type="button"
            onClick={() => setShowUserMenu(!showUserMenu)}
            aria-label="Account menu"
            title={resolvedUser.name}
            className="w-full flex items-center justify-center px-3 py-2 rounded-lg hover:bg-white/5 transition-colors"
          >
            <div className="size-7 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
              <IconCloseBold className="size-4" />
            </div>
          </button>
        </div>
      </div>
    );
  }

  // Expanded render path
  return (
    <>
      <div
        className="bg-foundation-bg-light-1 dark:bg-foundation-bg-dark-1 text-white flex flex-col h-full border-r border-foundation-bg-light-3 dark:border-white/10 transition-all duration-300 w-64"
      >
        <div className="flex items-center justify-between px-3 py-3">
          <div className="size-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center flex-shrink-0">
            <IconCloseBold className="size-4" />
          </div>
          <button
            onClick={() => setIsCollapsed(true)}
            className="size-8 flex items-center justify-center rounded-lg hover:bg-white/5 transition-colors"
            title="Collapse sidebar"
          >
            <IconSidebar className="size-5 text-foundation-text-light-tertiary dark:text-foundation-text-dark-tertiary" />
          </button>
        </div>

        <div className="px-2 pb-1">
          <ListItem icon={<IconCompose className="size-4" />} label="New chat" onClick={handleNewChat} />
        </div>

        <div className="px-2 pb-1">
          <ListItem icon={<IconSearch className="size-4" />} label="Search chats" />
        </div>

        <div className="px-2 pb-1">
          <ListItem icon={<Sparkles className="size-4" />} label="Your Year With ChatGPT" />
        </div>

        <div className="px-2 pb-1">
          <ListItem icon={<IconRadio className="size-4" />} label="Pulse" />
        </div>

        <div className="px-2 pb-1">
          <ListItem
            icon={<IconImage className="size-4" />}
            label="Images"
            right={
              <span className="text-[10px] font-semibold leading-[14px] tracking-[0.5px] px-1.5 py-0.5 bg-white/10 rounded text-white uppercase">
                NEW
              </span>
            }
          />
        </div>

        <div className="px-2 pb-1">
          <ListItem icon={<IconArchive className="size-4" />} label="Archived chats" />
        </div>

        <div className="flex-1 overflow-y-auto overflow-x-hidden">
          <div className="px-2 pb-1">
            <ListItem icon={<IconGrid3x3 className="size-4" />} label="Apps" />
          </div>

          <div className="px-2 pb-1">
            <ListItem icon={<IconCode className="size-4" />} label="Codex" />
          </div>

          <CollapsibleSection
            title="GPTs"
            expanded={gptsExpanded}
            onExpandedChange={(expanded: boolean) => setGptsExpanded(expanded)}
          />

          <CollapsibleSection
            title="Projects"
            expanded={projectsExpanded}
            onExpandedChange={(expanded: boolean) => setProjectsExpanded(expanded)}
          />

          {projectsExpanded && (
            <>
              <div className="px-2 pb-1">
                <Popover>
                  <Popover.Trigger>
                    <button type="button" className="w-full text-left">
                      <ListItem icon={<IconFolder className="size-4" />} label="New project" />
                    </button>
                  </Popover.Trigger>
                  <Popover.Content
                    side="right"
                    align="start"
                    sideOffset={12}
                    className="z-[60] w-[420px] rounded-2xl border border-white/10 bg-foundation-bg-dark-2 shadow-2xl outline-none"
                  >
                    <div className="px-6 pt-6 pb-5">
                      <p className="text-[13px] text-white/50 leading-[18px] tracking-[-0.32px] font-normal text-center">
                        Projects give ChatGPT shared context
                        <br />
                        across chats and files, all in one place.
                      </p>
                    </div>
                    <div className="px-6 pb-6">
                      <div className="relative mb-5">
                        <button
                          type="button"
                          onClick={(e) => {
                            e.stopPropagation();
                            setShowIconPicker(true);
                          }}
                          aria-label="Choose project icon"
                          title="Choose project icon"
                          className={`absolute left-3 top-1/2 -translate-y-1/2 hover:opacity-70 transition-opacity ${newProjectColor}`}
                        >
                          {getProjectIcon(newProjectIcon)}
                        </button>
                        <input
                          type="text"
                          placeholder="Project Name"
                          value={projectName}
                          onChange={(e) => setProjectName(e.target.value)}
                          className="w-full bg-foundation-bg-dark-3 border border-white/10 rounded-lg pl-10 pr-3 py-3 text-[14px] text-white placeholder:text-white/40 focus:outline-none focus:ring-1 focus:ring-white/20 transition-all font-normal leading-[20px] tracking-[-0.3px]"
                        />
                      </div>
                      {resolvedCategories.length > 0 ? (
                        <div className="mb-6">
                          <div
                            className="flex gap-2 overflow-x-auto pb-2 -mx-6 px-6 scrollbar-hide"
                            style={{ scrollbarWidth: "none", msOverflowStyle: "none" }}
                          >
                            {resolvedCategories.map((category) => {
                              const isSelected = selectedCategories.includes(category);
                              return (
                                <button
                                  key={category}
                                  onClick={() => toggleCategory(category)}
                                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[14px] border transition-all whitespace-nowrap flex-shrink-0 font-normal leading-[20px] tracking-[-0.3px] ${
                                    isSelected
                                      ? resolvedCategoryColors[
                                          category as keyof typeof resolvedCategoryColors
                                        ]
                                      : "bg-foundation-bg-dark-3 text-white/60 border-white/10 hover:bg-foundation-bg-dark-3/80"
                                  }`}
                                >
                                  {resolvedCategoryIcons[category] ? (
                                    <span
                                      className={
                                        resolvedCategoryIconColors[
                                          category as keyof typeof resolvedCategoryIconColors
                                        ]
                                      }
                                    >
                                      {
                                        resolvedCategoryIcons[
                                          category as keyof typeof resolvedCategoryIcons
                                        ]
                                      }
                                    </span>
                                  ) : null}
                                  <span>{category}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      ) : null}
                      <button
                        onClick={handleCreateProject}
                        disabled={!projectName.trim()}
                        className="w-full bg-foundation-accent-green hover:bg-foundation-accent-green/80 disabled:bg-foundation-bg-dark-3 disabled:text-white/30 disabled:cursor-not-allowed text-white py-3 rounded-lg transition-all text-[14px] font-normal leading-[20px] tracking-[-0.3px]"
                      >
                        Create project
                      </button>
                      <button
                        onClick={() => setShowMoreOptions(true)}
                        className="w-full bg-foundation-bg-dark-3 hover:bg-foundation-bg-dark-3/80 text-white/70 py-3 rounded-lg mt-2 transition-colors text-[14px] font-normal leading-[20px] tracking-[-0.3px]"
                      >
                        More options
                      </button>
                    </div>
                  </Popover.Content>
                </Popover>
              </div>
              {projectsData.map((project) => (
                <div
                  key={project.id}
                  className="px-2 pb-1"
                  onMouseEnter={() => setHoveredProject(project.id)}
                  onMouseLeave={() => setHoveredProject(null)}
                  onFocusCapture={() => setHoveredProject(project.id)}
                  onBlurCapture={() => setHoveredProject(null)}
                >
                  <ListItem
                    icon={renderProjectIcon(project)}
                    label={project.label}
                    onClick={() => handleProjectSelect(project)}
                    right={renderProjectActions(project.id)}
                  />
                </div>
              ))}
            </>
          )}

          {resolvedGroupChats.length > 0 && (
            <CollapsibleSection
              title="Group chats"
              expanded={groupChatsExpanded}
              onExpandedChange={(expanded: boolean) => setGroupChatsExpanded(expanded)}
            />
          )}

          {groupChatsExpanded && resolvedGroupChats.length > 0 && (
            <>
              {resolvedGroupChats.map((chat) => (
                <div
                  key={chat.id}
                  className="px-2 pb-1"
                  onMouseEnter={() => setHoveredProject(chat.id)}
                  onMouseLeave={() => setHoveredProject(null)}
                  onFocusCapture={() => setHoveredProject(chat.id)}
                  onBlurCapture={() => setHoveredProject(null)}
                >
                  <ListItem
                    icon={renderProjectIcon(chat)}
                    label={chat.label}
                    onClick={() => handleProjectSelect(chat)}
                    right={renderProjectActions(chat.id)}
                  />
                </div>
              ))}
            </>
          )}

          {resolvedChatHistory.length > 0 && (
            <CollapsibleSection
              title="Your chats"
              expanded={yourChatsExpanded}
              onExpandedChange={(expanded: boolean) => setYourChatsExpanded(expanded)}
            />
          )}

          {yourChatsExpanded && resolvedChatHistory.length > 0 && (
            <>
              {resolvedChatHistory.slice(0, 5).map((chat) => (
                <div key={chat} className="px-2 pb-1">
                  <ListItem label={chat} />
                </div>
              ))}
            </>
          )}
        </div>

        {/* Slot: sidebarFooter (must be inside sidebar so it doesn't become a separate flex item) */}
        {sidebarFooter ? <div className="px-2 pb-2">{sidebarFooter}</div> : null}

        <div className="p-2 border-t border-white/10 relative">
          <button
            onClick={() => setShowUserMenu(!showUserMenu)}
            className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 transition-colors"
          >
            <div className="size-7 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center flex-shrink-0">
              <IconCloseBold className="size-4" />
            </div>
            <div className="flex flex-col items-start flex-1 min-w-0">
              <span className="text-[14px] truncate font-normal leading-[20px] tracking-[-0.3px] text-white">
                {resolvedUser.name}
              </span>
              <span className="text-[12px] font-normal leading-[16px] tracking-[-0.3px] text-foundation-text-light-tertiary dark:text-foundation-text-dark-tertiary">
                {resolvedUser.accountLabel}
              </span>
            </div>
          </button>
          {showUserMenu && (
            <div className="absolute bottom-full left-3 right-3 mb-2 bg-foundation-bg-dark-2 border border-white/20 rounded-xl shadow-2xl py-1 z-50">
              <div className="px-3 py-2.5 border-b border-white/10">
                <div className="flex items-center gap-2 text-[13px]">
                  <div className="size-2 rounded-full bg-foundation-accent-green" />
                  <span className="text-white/70 font-normal">{resolvedUser.planLabel}</span>
                </div>
              </div>
              <button className="w-full text-left px-3 py-2.5 hover:bg-white/5 transition-colors flex items-center gap-2">
                <svg
                  className="size-4 text-white/70"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                <span className="text-[14px] text-white font-normal leading-[20px] tracking-[-0.3px]">
                  {resolvedUser.accountLabel}
                </span>
              </button>
              <button
                onClick={() => {
                  setShowUserMenu(false);
                  setShowSettingsModal(true);
                }}
                className="w-full text-left px-3 py-2.5 hover:bg-white/5 transition-colors flex items-center gap-2"
              >
                <IconSettings className="size-4 text-white/70" />
                <span className="text-[14px] text-white font-normal leading-[20px] tracking-[-0.3px]">
                  Settings
                </span>
              </button>
              <div className="my-1 border-t border-white/10" />
              <button className="w-full text-left px-3 py-2.5 hover:bg-white/5 transition-colors">
                <span className="text-[14px] text-white font-normal leading-[20px] tracking-[-0.3px]">
                  Log Out
                </span>
              </button>
            </div>
          )}
        </div>

        {showIconPicker && selectedProjectForIcon && (
          <IconPickerModal
            isOpen={showIconPicker}
            onClose={() => {
              setShowIconPicker(false);
              setSelectedProjectForIcon(null);
            }}
            onSave={handleIconChange}
            currentColor={selectedProjectForIcon.color}
            projectName={selectedProjectForIcon.label}
          />
        )}

        {showIconPicker && !selectedProjectForIcon && (
          <IconPickerModal
            isOpen={showIconPicker}
            onClose={() => {
              setShowIconPicker(false);
              setShowMoreOptions(false);
            }}
            onSave={handleNewProjectIconChange}
            currentColor={newProjectColor}
            projectName={projectName || "New Project"}
          />
        )}

        {showMoreOptions && !showIconPicker && (
          <ProjectSettingsModal
            memoryOption={memoryOption}
            onSelectMemoryOption={setMemoryOption}
            onClose={() => setShowMoreOptions(false)}
            onDone={() => {
              console.log("Memory option:", memoryOption);
              setShowMoreOptions(false);
            }}
          />
        )}

        {showSettingsModal && (
          <SettingsModal
            isOpen={showSettingsModal}
            onClose={() => setShowSettingsModal(false)}
            account={{ subscriptionLabel: resolvedUser.planLabel }}
          />
        )}
      </div>
    </>
  );
}
